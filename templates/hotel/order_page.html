{% extends 'base.html' %}
{% load l10n %}
{% load pluralize_ru %}

{% block title %}–ú–µ–Ω—é - {% if floor %}{{ floor.name }}{% elif building %}{{ building.name }}{% else %}{{ room }}{% endif %}{% endblock %}

{% block extra_head %}
<style>
    .category-tab {
        scroll-margin-top: 140px;
    }
    .product-card {
        transition: all 0.3s ease;
    }
    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        border-color: #e5e7eb;
    }
    .product-card img {
        transition: transform 0.3s ease;
    }
    .product-card:hover img {
        transform: scale(1.05);
    }
    .category-card {
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    }
    .category-card:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }
    .order-status-badge {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    .scroll-to-top {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 40;
    }
    .scroll-to-top.visible {
        opacity: 1;
        visibility: visible;
    }
    .scroll-to-top:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
    }
    .scroll-to-top:active {
        transform: translateY(-1px);
    }
    @media (max-width: 768px) {
        .scroll-to-top {
            bottom: 80px;
            right: 16px;
            width: 44px;
            height: 44px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50">
    <!-- Modern Header -->
    <header class="sticky top-0 left-0 right-0 bg-white/95 backdrop-blur-md border-b border-gray-200 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <!-- Top row: Logo and Cart -->
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    {% if site_settings.logo %}
                    <img src="{{ site_settings.logo.url }}" alt="{{ site_settings.site_name }}" class="h-10 w-10 object-contain rounded-lg">
                    {% endif %}
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">{{ site_settings.site_name }}</h1>
                        <p class="text-xs text-gray-500">
                            {% if floor %}
                                –≠—Ç–∞–∂ {{ floor.name }}
                            {% elif building %}
                                –ö–æ—Ä–ø—É—Å {{ building.name }}
                            {% else %}
                                –ù–æ–º–µ—Ä {{ room }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                <button onclick="toggleCart()" class="relative bg-gradient-to-r from-gray-900 to-gray-800 text-white px-5 py-2.5 rounded-xl hover:from-gray-800 hover:to-gray-700 transition-all shadow-lg hover:shadow-xl font-medium text-sm">
                    <span class="flex items-center space-x-2">
                        <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
                        <span id="cart-badge" class="bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold">0</span>
                    </span>
                </button>
            </div>
            
            <!-- Active Order Status -->
            {% if active_order %}
            <div class="mb-3 bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-xl p-3 order-status-badge">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></div>
                        <div>
                            <p class="text-sm font-semibold text-amber-900">–ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑ #{{ active_order.id }}</p>
                            <p class="text-xs text-amber-700">–°—Ç–∞—Ç—É—Å: <span class="font-medium">{{ active_order.get_status_display }}</span></p>
                        </div>
                    </div>
                    <a href="{% if floor %}{% url 'floor_order_status' floor.slug active_order.id %}{% elif building %}{% url 'building_order_status' building.slug active_order.id %}{% else %}{% url 'order_status' room.slug active_order.id %}{% endif %}" class="text-xs bg-amber-600 text-white px-3 py-1.5 rounded-lg hover:bg-amber-700 transition font-medium">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- Categories Navigation - Modern Pills -->
            <nav class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                <a href="#categories-grid" 
                   class="category-tab whitespace-nowrap px-4 py-2 rounded-full bg-gray-900 text-white text-sm font-medium hover:bg-gray-800 transition shadow-md">
                    –í—Å–µ
                </a>
                {% for category in categories %}
                <a href="#category-{{ category.id }}" 
                   class="category-tab whitespace-nowrap px-4 py-2 rounded-full bg-white text-gray-700 border border-gray-200 text-sm font-medium hover:bg-gray-50 hover:border-gray-300 transition shadow-sm">
                    {{ category.name }}
                </a>
                {% endfor %}
            </nav>
        </div>
    </header>

    <!-- Menu Content -->
    <main class="max-w-7xl mx-auto px-4 pt-8 pb-32">
        <!-- Modern Categories Grid -->
        <section id="categories-grid" class="category-tab mb-20">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
                    <p class="text-gray-500 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–Ω—é</p>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                {% for category in categories %}
                <a href="#category-{{ category.id }}" class="group block">
                    <div class="category-card rounded-2xl overflow-hidden border border-gray-200 h-full">
                        <div class="aspect-square bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center overflow-hidden relative">
                            {% if category.image %}
                            <img src="{{ category.image.url }}" alt="{{ category.name }}" 
                                 class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center">
                                <span class="text-6xl text-gray-300 group-hover:scale-110 transition-transform">üìÅ</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="p-4 text-center bg-white">
                            <h3 class="font-bold text-gray-900 text-sm mb-1 leading-tight">{{ category.name }}</h3>
                            <p class="text-xs text-gray-500">{{ category.products.count }} {{ category.products.count|pluralize_ru:"–±–ª—é–¥–æ,–±–ª—é–¥–∞,–±–ª—é–¥" }}</p>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </section>

        <!-- Products by Category - Keep existing cards -->
        {% for category in categories %}
        <section id="category-{{ category.id }}" class="category-tab mb-20">
            <div class="flex items-center space-x-4 mb-8">
                {% if category.image %}
                <img src="{{ category.image.url }}" alt="{{ category.name }}" class="w-12 h-12 object-cover rounded-xl shadow-md">
                {% endif %}
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">{{ category.name }}</h2>
                    <p class="text-gray-500 text-sm">{{ category.products.count }} {{ category.products.count|pluralize_ru:"–±–ª—é–¥–æ,–±–ª—é–¥–∞,–±–ª—é–¥" }} –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for product in category.products.all %}
                {% if product.is_available %}
                <div class="product-card bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all">
                    <div class="flex flex-col md:flex-row">
                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –∫—Ä—É–ø–Ω–µ–µ -->
                        <div class="w-full md:w-48 h-48 md:h-auto flex-shrink-0 bg-gray-50">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200">
                                <span class="text-6xl text-gray-300">üçΩÔ∏è</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="flex-1 p-5 flex flex-col min-w-0">
                            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ -->
                            <div class="flex-1 mb-4">
                                <h3 class="font-bold text-gray-900 mb-2 text-lg leading-tight">{{ product.name }}</h3>
                                {% if product.description %}
                                <p class="text-sm text-gray-600 mb-3 leading-relaxed">{{ product.description }}</p>
                                {% endif %}
                                
                                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –≤–∏–¥–µ –∏–∫–æ–Ω–æ–∫ -->
                                {% if product.weight or product.calories or product.cooking_time %}
                                <div class="flex flex-wrap gap-3 mb-3">
                                    {% if product.weight %}
                                    <div class="flex items-center text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                        <span class="mr-1">‚öñÔ∏è</span>
                                        <span>{{ product.weight }}</span>
                                    </div>
                                    {% endif %}
                                    {% if product.calories %}
                                    <div class="flex items-center text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                        <span class="mr-1">üî•</span>
                                        <span>{{ product.calories }} –∫–∫–∞–ª</span>
                                    </div>
                                    {% endif %}
                                    {% if product.cooking_time %}
                                    <div class="flex items-center text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                        <span class="mr-1">‚è±Ô∏è</span>
                                        <span>{{ product.cooking_time }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º–∞—è) -->
                                <div class="space-y-2 text-xs text-gray-500">
                                    {% if product.composition %}
                                    <div class="flex items-start">
                                        <span class="font-medium text-gray-700 mr-2 min-w-[60px]">–°–æ—Å—Ç–∞–≤:</span>
                                        <span class="flex-1">{{ product.composition|truncatewords:15 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if product.allergens %}
                                    <div class="flex items-start">
                                        <span class="font-medium text-amber-700 mr-2 min-w-[60px]">‚ö†Ô∏è –ê–ª–ª–µ—Ä–≥–µ–Ω—ã:</span>
                                        <span class="flex-1 text-amber-700">{{ product.allergens }}</span>
                                    </div>
                                    {% endif %}
                                    {% if product.nutritional_info %}
                                    <div class="flex items-start">
                                        <span class="font-medium text-gray-700 mr-2 min-w-[60px]">–ü–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å:</span>
                                        <span class="flex-1">{{ product.nutritional_info|truncatewords:12 }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- –¶–µ–Ω–∞ –∏ –∫–Ω–æ–ø–∫–∞ -->
                            <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                                <div>
                                    <span class="text-2xl font-bold text-gray-900">{{ product.price|floatformat:2 }} ‚ÇΩ</span>
                                </div>
                                <button onclick="addToCart({{ product.id }})" 
                                        class="bg-gray-900 text-white w-12 h-12 rounded-xl hover:bg-gray-800 active:scale-95 transition-all flex items-center justify-center font-bold text-2xl flex-shrink-0 shadow-md hover:shadow-lg">
                                    +
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </section>
        {% endfor %}
    </main>

    <!-- Modern Fixed Cart Bottom Bar -->
    <div id="cart-bar" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-200 shadow-2xl z-50 hidden">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">–ò—Ç–æ–≥–æ</div>
                    <div id="cart-total-bar" class="text-2xl font-bold text-gray-900">0 ‚ÇΩ</div>
                </div>
                <button onclick="showCartModal()" class="bg-gradient-to-r from-gray-900 to-gray-800 text-white px-8 py-3 rounded-xl hover:from-gray-800 hover:to-gray-700 transition-all shadow-lg hover:shadow-xl font-medium">
                    –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Modern Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
        <div class="absolute right-0 top-0 h-full w-full md:w-96 bg-white shadow-2xl overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6 pb-4 border-b">
                    <h2 class="text-2xl font-bold text-gray-900">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                    <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="cart-items" class="space-y-4 mb-6">
                    <p class="text-gray-500 text-center py-8">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
                </div>
                <div class="border-t pt-6 sticky bottom-0 bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xl font-bold text-gray-900">–ò—Ç–æ–≥–æ:</span>
                        <span id="cart-total" class="text-3xl font-bold text-gray-900">0 ‚ÇΩ</span>
                    </div>
                    <button onclick="createOrder()" id="checkout-btn" class="w-full bg-gradient-to-r from-gray-900 to-gray-800 text-white py-4 rounded-xl hover:from-gray-800 hover:to-gray-700 transition-all shadow-lg hover:shadow-xl font-medium text-lg" disabled>
                        –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scroll to Top Button -->
<button id="scroll-to-top" class="scroll-to-top" onclick="scrollToTop()" aria-label="–ù–∞–≤–µ—Ä—Ö">
    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
    </svg>
</button>

<script>
{% if floor %}
const isBuilding = false;
const isFloor = true;
const entitySlug = '{{ floor.slug }}';
const entityName = '{{ floor.name }}';
{% elif building %}
const isBuilding = true;
const isFloor = false;
const entitySlug = '{{ building.slug }}';
const entityName = '{{ building.name }}';
{% else %}
const isBuilding = false;
const isFloor = false;
const entitySlug = '{{ room.slug }}';
const entityName = '{{ room }}';
{% endif %}

function toggleCart() {
    const modal = document.getElementById('cart-modal');
    modal.classList.toggle('hidden');
    if (!modal.classList.contains('hidden')) {
        updateCartUI();
    }
}

function showCartModal() {
    document.getElementById('cart-modal').classList.remove('hidden');
    updateCartUI();
}

function closeCart() {
    document.getElementById('cart-modal').classList.add('hidden');
}

function addToCart(productId) {
    let url;
    if (isFloor) {
        url = `/floor/${entitySlug}/cart/add/`;
    } else if (isBuilding) {
        url = `/building/${entitySlug}/cart/add/`;
    } else {
        url = `/order/${entitySlug}/cart/add/`;
    }
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCartUI();
            document.getElementById('cart-bar').classList.remove('hidden');
        }
    });
}

function removeFromCart(productId) {
    let url;
    if (isFloor) {
        url = `/floor/${entitySlug}/cart/remove/`;
    } else if (isBuilding) {
        url = `/building/${entitySlug}/cart/remove/`;
    } else {
        url = `/order/${entitySlug}/cart/remove/`;
    }
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCartUI();
        }
    });
}

function updateQuantity(productId, quantity) {
    if (quantity <= 0) {
        removeFromCart(productId);
        return;
    }
    let url;
    if (isFloor) {
        url = `/floor/${entitySlug}/cart/update/`;
    } else if (isBuilding) {
        url = `/building/${entitySlug}/cart/update/`;
    } else {
        url = `/order/${entitySlug}/cart/update/`;
    }
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCartUI();
        }
    });
}

function updateCartUI() {
    let url;
    if (isFloor) {
        url = `/floor/${entitySlug}/cart/`;
    } else if (isBuilding) {
        url = `/building/${entitySlug}/cart/`;
    } else {
        url = `/order/${entitySlug}/cart/`;
    }
    fetch(url)
    .then(response => response.json())
    .then(data => {
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const cartTotalHeader = document.getElementById('cart-total-header');
        const cartTotalBar = document.getElementById('cart-total-bar');
        const cartBadge = document.getElementById('cart-badge');
        const cartBar = document.getElementById('cart-bar');
        const checkoutBtn = document.getElementById('checkout-btn');
        
        if (data.items && data.items.length > 0) {
            cartItems.innerHTML = data.items.map(item => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900 mb-1">${item.name}</p>
                        <p class="text-sm text-gray-600">${item.price} ‚ÇΩ x ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-3 ml-4">
                        <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})" class="bg-white border border-gray-300 text-gray-700 w-9 h-9 rounded-lg hover:bg-gray-50 font-bold shadow-sm">-</button>
                        <span class="font-semibold w-8 text-center">${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})" class="bg-white border border-gray-300 text-gray-700 w-9 h-9 rounded-lg hover:bg-gray-50 font-bold shadow-sm">+</button>
                        <button onclick="removeFromCart(${item.id})" class="text-red-600 hover:text-red-800 ml-2 p-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            const total = parseFloat(data.total).toFixed(2);
            cartTotal.textContent = total + ' ‚ÇΩ';
            cartTotalBar.textContent = total + ' ‚ÇΩ';
            cartBadge.textContent = data.count;
            checkoutBtn.disabled = false;
            cartBar.classList.remove('hidden');
        } else {
            cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
            cartTotal.textContent = '0 ‚ÇΩ';
            cartTotalBar.textContent = '0 ‚ÇΩ';
            cartBadge.textContent = '0';
            checkoutBtn.disabled = true;
            cartBar.classList.add('hidden');
        }
    });
}

function createOrder() {
    let url;
    if (isFloor) {
        url = `/floor/${entitySlug}/create/`;
    } else if (isBuilding) {
        url = `/building/${entitySlug}/create/`;
    } else {
        url = `/order/${entitySlug}/create/`;
    }
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize category navigation after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll for category links (navigation pills)
    document.querySelectorAll('nav .category-tab').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            scrollToCategory(targetId);
            updateActiveNavLink(targetId);
        });
    });

    // Smooth scroll for category cards
    document.querySelectorAll('#categories-grid a[href^="#category-"]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            scrollToCategory(targetId);
            updateActiveNavLink(targetId);
        });
    });
});

function scrollToCategory(targetId) {
    const targetElement = document.querySelector(targetId);
    if (targetElement) {
        const headerHeight = 140;
        const elementPosition = targetElement.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
    }
}

function updateActiveNavLink(targetId) {
    document.querySelectorAll('nav .category-tab').forEach(l => {
        l.classList.remove('bg-gray-900', 'text-white', 'border-gray-900');
        l.classList.add('bg-white', 'text-gray-700', 'border-gray-200');
    });
    if (targetId !== '#categories-grid') {
        const activeLink = document.querySelector(`nav a[href="${targetId}"]`);
        if (activeLink) {
            activeLink.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
            activeLink.classList.add('bg-gray-900', 'text-white', 'border-gray-900');
        }
    }
}

// Smooth scroll for category cards
document.querySelectorAll('#categories-grid a[href^="#category-"]').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href');
        const targetElement = document.querySelector(targetId);
        if (targetElement) {
            const headerHeight = 140;
            const elementPosition = targetElement.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
            
            // Update active state in navigation
            document.querySelectorAll('nav .category-tab').forEach(l => {
                l.classList.remove('bg-gray-900', 'text-white', 'border-gray-900');
                l.classList.add('bg-white', 'text-gray-700', 'border-gray-200');
            });
            const navLink = document.querySelector(`nav a[href="${targetId}"]`);
            if (navLink) {
                navLink.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
                navLink.classList.add('bg-gray-900', 'text-white', 'border-gray-900');
            }
        }
    });
});

// Highlight active category on scroll
let currentCategory = '';
window.addEventListener('scroll', () => {
    const sections = document.querySelectorAll('section[id^="category-"]');
    const scrollPos = window.scrollY + 160;
    
    sections.forEach(section => {
        const top = section.offsetTop;
        const bottom = top + section.offsetHeight;
        const id = section.getAttribute('id');
        
        if (scrollPos >= top && scrollPos < bottom) {
            if (currentCategory !== id) {
                currentCategory = id;
                document.querySelectorAll('.category-tab').forEach(link => {
                    link.classList.remove('bg-gray-900', 'text-white', 'border-gray-900');
                    link.classList.add('bg-white', 'text-gray-700', 'border-gray-200');
                });
                const activeLink = document.querySelector(`a[href="#${id}"]`);
                if (activeLink) {
                    activeLink.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
                    activeLink.classList.add('bg-gray-900', 'text-white', 'border-gray-900');
                }
            }
        }
    });
});

// Load cart on page load
updateCartUI();

// Update cart UI every 2 seconds
setInterval(updateCartUI, 2000);

// Scroll to top button
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Show/hide scroll to top button
window.addEventListener('scroll', () => {
    const scrollButton = document.getElementById('scroll-to-top');
    if (window.scrollY > 300) {
        scrollButton.classList.add('visible');
    } else {
        scrollButton.classList.remove('visible');
    }
});
</script>
{% endblock %}
