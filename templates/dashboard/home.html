{% extends 'dashboard/base.html' %}

{% block title %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–∫–∞–∑–æ–≤{% endblock %}

{% block content %}
<div class="mb-6 md:mb-8">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Live –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h1>
    <p class="text-sm md:text-base text-gray-600">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
    <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs md:text-sm">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</p>
                <p class="text-2xl md:text-3xl font-bold text-yellow-600">{{ stats.new_orders }}</p>
            </div>
            <div class="w-10 h-10 md:w-12 md:h-12 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-xl md:text-2xl">üÜï</span>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs md:text-sm">–ì–æ—Ç–æ–≤—è—Ç—Å—è</p>
                <p class="text-2xl md:text-3xl font-bold text-blue-600">{{ stats.cooking_orders }}</p>
            </div>
            <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-xl md:text-2xl">üç≥</span>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs md:text-sm">–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è</p>
                <p class="text-2xl md:text-3xl font-bold text-indigo-600">{{ stats.today_orders_count }}</p>
            </div>
            <div class="w-10 h-10 md:w-12 md:h-12 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-xl md:text-2xl">üìã</span>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-xs md:text-sm">–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è</p>
                <p class="text-2xl md:text-3xl font-bold text-green-600">{{ stats.today_revenue|floatformat:0 }} ‚ÇΩ</p>
            </div>
            <div class="w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-xl md:text-2xl">üí∞</span>
            </div>
        </div>
    </div>
</div>

<!-- Orders Kanban -->
<div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
        <button onclick="location.reload()" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2.5 rounded-lg hover:bg-indigo-700 transition font-medium touch-manipulation">
            –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6" id="orders-container">
        <!-- New Orders -->
        <div data-status="new">
            <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4 bg-yellow-100 px-3 md:px-4 py-2 rounded-lg">üÜï –ù–æ–≤—ã–µ</h3>
            <div class="space-y-3 md:space-y-4">
                {% for order in orders %}
                {% if order.status == 'new' %}
                <div id="order-{{ order.id }}" class="bg-white border-2 border-yellow-200 rounded-lg p-3 md:p-4 shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">–ó–∞–∫–∞–∑ #{{ order.id }}</p>
                            <div class="text-sm text-gray-600 mt-1">
                                {% if order.room %}
                                <p class="font-medium">üìç {{ order.room.number }}</p>
                                {% if order.room.floor.building %}
                                <p class="text-xs text-gray-500">{{ order.room.floor.building.name }}, –≠—Ç–∞–∂ {{ order.room.floor.number }}</p>
                                {% else %}
                                <p class="text-xs text-gray-500">–≠—Ç–∞–∂ {{ order.room.floor.number }}</p>
                                {% endif %}
                                {% elif order.building %}
                                <p class="font-medium">üìç –ö–æ—Ä–ø—É—Å {{ order.building.name }}</p>
                                {% else %}
                                <p class="font-medium">üìç –ù–µ —É–∫–∞–∑–∞–Ω–æ</p>
                                {% endif %}
                            </div>
                        </div>
                        <span class="text-base md:text-lg font-bold text-indigo-600 ml-2 whitespace-nowrap">{{ order.total_price|floatformat:2 }} ‚ÇΩ</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-3">{{ order.created_at|date:"H:i:s" }}</p>
                    <div class="bg-gray-50 rounded-lg p-2 md:p-3 mb-3">
                        <p class="text-xs font-semibold text-gray-700 mb-2">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</p>
                        <div class="space-y-1">
                            {% for item in order.items.all %}
                            <div class="flex justify-between items-center text-xs md:text-sm">
                                <span class="text-gray-700 flex-1 pr-2 truncate">{{ item.product.name }}</span>
                                <span class="text-gray-600 font-medium whitespace-nowrap">x{{ item.quantity }} = {{ item.price_at_moment|floatformat:2 }} ‚ÇΩ</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <button onclick="updateOrderStatus({{ order.id }}, 'cooking')" class="flex-1 bg-blue-600 text-white px-4 py-2.5 rounded text-sm font-medium hover:bg-blue-700 transition touch-manipulation">
                            –ü—Ä–∏–Ω—è—Ç—å
                        </button>
                        <button onclick="updateOrderStatus({{ order.id }}, 'done')" class="flex-1 bg-green-600 text-white px-4 py-2.5 rounded text-sm font-medium hover:bg-green-700 transition touch-manipulation">
                            –ì–æ—Ç–æ–≤–æ
                        </button>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Cooking Orders -->
        <div data-status="cooking">
            <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4 bg-blue-100 px-3 md:px-4 py-2 rounded-lg">üç≥ –ì–æ—Ç–æ–≤—è—Ç—Å—è</h3>
            <div class="space-y-3 md:space-y-4">
                {% for order in orders %}
                {% if order.status == 'cooking' %}
                <div id="order-{{ order.id }}" class="bg-white border-2 border-blue-200 rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">–ó–∞–∫–∞–∑ #{{ order.id }}</p>
                            <div class="text-sm text-gray-600 mt-1">
                                {% if order.room %}
                                <p class="font-medium">üìç {{ order.room.number }}</p>
                                {% if order.room.floor.building %}
                                <p class="text-xs text-gray-500">{{ order.room.floor.building.name }}, –≠—Ç–∞–∂ {{ order.room.floor.number }}</p>
                                {% else %}
                                <p class="text-xs text-gray-500">–≠—Ç–∞–∂ {{ order.room.floor.number }}</p>
                                {% endif %}
                                {% elif order.building %}
                                <p class="font-medium">üìç –ö–æ—Ä–ø—É—Å {{ order.building.name }}</p>
                                {% else %}
                                <p class="font-medium">üìç –ù–µ —É–∫–∞–∑–∞–Ω–æ</p>
                                {% endif %}
                            </div>
                        </div>
                        <span class="text-base md:text-lg font-bold text-indigo-600 ml-2 whitespace-nowrap">{{ order.total_price|floatformat:2 }} ‚ÇΩ</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-3">{{ order.created_at|date:"H:i:s" }}</p>
                    <div class="bg-gray-50 rounded-lg p-2 md:p-3 mb-3">
                        <p class="text-xs font-semibold text-gray-700 mb-2">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</p>
                        <div class="space-y-1">
                            {% for item in order.items.all %}
                            <div class="flex justify-between items-center text-xs md:text-sm">
                                <span class="text-gray-700 flex-1 pr-2 truncate">{{ item.product.name }}</span>
                                <span class="text-gray-600 font-medium whitespace-nowrap">x{{ item.quantity }} = {{ item.price_at_moment|floatformat:2 }} ‚ÇΩ</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <button onclick="updateOrderStatus({{ order.id }}, 'done')" class="w-full bg-green-600 text-white px-4 py-3 rounded text-sm font-medium hover:bg-green-700 transition touch-manipulation">
                        ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                    </button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Done Orders -->
        <div data-status="done">
            <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4 bg-green-100 px-3 md:px-4 py-2 rounded-lg">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω—ã</h3>
            <div class="space-y-3 md:space-y-4">
                {% for order in orders %}
                {% if order.status == 'done' %}
                <div id="order-{{ order.id }}" class="bg-white border-2 border-green-200 rounded-lg p-4 shadow-sm opacity-75">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">–ó–∞–∫–∞–∑ #{{ order.id }}</p>
                            <div class="text-sm text-gray-600 mt-1">
                                {% if order.room %}
                                <p class="font-medium">üìç {{ order.room.number }}</p>
                                {% if order.room.floor.building %}
                                <p class="text-xs text-gray-500">{{ order.room.floor.building.name }}, –≠—Ç–∞–∂ {{ order.room.floor.number }}</p>
                                {% else %}
                                <p class="text-xs text-gray-500">–≠—Ç–∞–∂ {{ order.room.floor.number }}</p>
                                {% endif %}
                                {% elif order.building %}
                                <p class="font-medium">üìç –ö–æ—Ä–ø—É—Å {{ order.building.name }}</p>
                                {% else %}
                                <p class="font-medium">üìç –ù–µ —É–∫–∞–∑–∞–Ω–æ</p>
                                {% endif %}
                            </div>
                        </div>
                        <span class="text-base md:text-lg font-bold text-indigo-600 ml-2 whitespace-nowrap">{{ order.total_price|floatformat:2 }} ‚ÇΩ</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-3">{{ order.created_at|date:"H:i:s" }}</p>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs font-semibold text-gray-700 mb-2">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</p>
                        <div class="space-y-1">
                            {% for item in order.items.all %}
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-700">{{ item.product.name }}</span>
                                <span class="text-gray-600 font-medium">x{{ item.quantity }} = {{ item.price_at_moment|floatformat:2 }} ‚ÇΩ</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function updateOrderStatus(orderId, status) {
    const formData = new FormData();
    formData.append('status', status);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch(`/dashboard/orders/${orderId}/update-status/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞
            updateOrders(true);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
let ordersUpdateInterval;
let lastOrdersHash = '';

document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ö–µ—à —Ç–µ–∫—É—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
    fetch('/api/orders/live/')
        .then(response => response.json())
        .then(data => {
            if (data.orders) {
                lastOrdersHash = data.orders.map(o => `order-${o.id}-${o.status}`).sort().join(',');
            }
        });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑—ã –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    ordersUpdateInterval = setInterval(() => {
        if (!document.hidden) {
            updateOrders(false);
        }
    }, 3000);
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —è–∫–æ—Ä—å –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∑–∞–∫–∞–∑—É
    if (window.location.hash) {
        const orderId = window.location.hash.replace('#order-', '');
        setTimeout(() => {
            const orderElement = document.getElementById('order-' + orderId);
            if (orderElement) {
                orderElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                orderElement.classList.add('ring-4', 'ring-yellow-400', 'ring-opacity-50');
                setTimeout(() => {
                    orderElement.classList.remove('ring-4', 'ring-yellow-400', 'ring-opacity-50');
                }, 2000);
            }
        }, 500);
    }
});

function getOrdersHash() {
    const orders = document.querySelectorAll('[id^="order-"]');
    return Array.from(orders).map(el => el.id).sort().join(',');
}

function updateOrders(force = false) {
    fetch('/api/orders/live/')
        .then(response => response.json())
        .then(data => {
            if (data.orders) {
                // –°–æ–∑–¥–∞–µ–º —Ö–µ—à –Ω–∞ –æ—Å–Ω–æ–≤–µ ID –∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤
                const currentHash = data.orders.map(o => `order-${o.id}-${o.status}`).sort().join(',');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
                if (force || currentHash !== lastOrdersHash) {
                    renderOrders(data.orders);
                    lastOrdersHash = currentHash;
                }
            }
        })
        .catch(error => console.error('Error updating orders:', error));
}

function renderOrders(orders) {
    const container = document.getElementById('orders-container');
    if (!container) return;
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    const ordersByStatus = {
        'new': [],
        'cooking': [],
        'done': []
    };
    
    orders.forEach(order => {
        if (ordersByStatus.hasOwnProperty(order.status)) {
            ordersByStatus[order.status].push(order);
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –∫–æ–ª–æ–Ω–∫—É
    ['new', 'cooking', 'done'].forEach(status => {
        const statusContainer = container.querySelector(`[data-status="${status}"]`);
        if (!statusContainer) return;
        
        const ordersList = statusContainer.querySelector('.space-y-3, .space-y-4');
        if (!ordersList) return;
        
        ordersList.innerHTML = ordersByStatus[status].map(order => renderOrderCard(order, status)).join('');
    });
}

function renderOrderCard(order, status) {
    const statusConfig = {
        'new': { border: 'border-yellow-200', bg: 'bg-yellow-100', title: 'üÜï –ù–æ–≤—ã–µ', buttons: true },
        'cooking': { border: 'border-blue-200', bg: 'bg-blue-100', title: 'üç≥ –ì–æ—Ç–æ–≤—è—Ç—Å—è', buttons: false },
        'done': { border: 'border-green-200', bg: 'bg-green-100', title: '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω—ã', buttons: false, opacity: 'opacity-75' }
    };
    
    const config = statusConfig[status] || statusConfig['new'];
    
    let buttonsHtml = '';
    if (status === 'new') {
        buttonsHtml = `
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <button onclick="updateOrderStatus(${order.id}, 'cooking')" class="flex-1 bg-blue-600 text-white px-4 py-2.5 rounded text-sm font-medium hover:bg-blue-700 transition touch-manipulation">
                    –ü—Ä–∏–Ω—è—Ç—å
                </button>
                <button onclick="updateOrderStatus(${order.id}, 'done')" class="flex-1 bg-green-600 text-white px-4 py-2.5 rounded text-sm font-medium hover:bg-green-700 transition touch-manipulation">
                    –ì–æ—Ç–æ–≤–æ
                </button>
            </div>
        `;
    } else if (status === 'cooking') {
        buttonsHtml = `
            <button onclick="updateOrderStatus(${order.id}, 'done')" class="w-full bg-green-600 text-white px-4 py-3 rounded text-sm font-medium hover:bg-green-700 transition touch-manipulation">
                ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
            </button>
        `;
    }
    
    const itemsHtml = order.items.map(item => `
        <div class="flex justify-between items-center text-xs md:text-sm">
            <span class="text-gray-700 flex-1 pr-2 truncate">${item.name}</span>
            <span class="text-gray-600 font-medium whitespace-nowrap">x${item.quantity} = ${item.price.toFixed(2)} ‚ÇΩ</span>
        </div>
    `).join('');
    
    const buildingInfo = order.building ? `${order.building}, –≠—Ç–∞–∂ ${order.floor}` : `–≠—Ç–∞–∂ ${order.floor}`;
    
    return `
        <div id="order-${order.id}" class="bg-white border-2 ${config.border} rounded-lg p-3 md:p-4 shadow-sm ${config.opacity || ''}">
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    <p class="font-bold text-gray-800">–ó–∞–∫–∞–∑ #${order.id}</p>
                    <div class="text-sm text-gray-600 mt-1">
                        <p class="font-medium">üìç ${order.room_number ? order.room_number : (order.building ? '–ö–æ—Ä–ø—É—Å ' + order.building : '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}</p>
                        <p class="text-xs text-gray-500">${buildingInfo}</p>
                    </div>
                </div>
                <span class="text-base md:text-lg font-bold text-indigo-600 ml-2 whitespace-nowrap">${order.total_price.toFixed(2)} ‚ÇΩ</span>
            </div>
            <p class="text-xs text-gray-500 mb-3">${order.created_at}</p>
            <div class="bg-gray-50 rounded-lg p-2 md:p-3 mb-3">
                <p class="text-xs font-semibold text-gray-700 mb-2">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</p>
                <div class="space-y-1">
                    ${itemsHtml}
                </div>
            </div>
            ${buttonsHtml}
        </div>
    `;
}
</script>
{% endblock %}

